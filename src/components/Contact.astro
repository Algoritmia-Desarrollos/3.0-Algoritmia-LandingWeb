---
import Button from './UI/Button.astro';
---

<section class="py-24 px-6 md:px-12 bg-surface" id="contact">
  <div class="max-w-2xl mx-auto reveal">
    <div class="bg-white p-8 md:p-14 rounded-3xl shadow-apple hover:shadow-apple-hover transition-shadow duration-300 border border-white">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-semibold mb-3 tracking-tight">¿Tu negocio está listo para escalar?</h2>
        <p class="text-sm text-primary/50">Cuéntanos sobre tu proyecto y te contactaremos en menos de 24h.</p>
      </div>
      
      <!-- Success Message -->
      <div id="success-message" class="hidden mb-8 p-4 bg-green-50 border border-green-200 rounded-xl text-center">
        <p class="text-green-700 font-medium">¡Mensaje enviado con éxito!</p>
        <p class="text-green-600 text-sm mt-1">Te contactaremos pronto.</p>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="hidden mb-8 p-4 bg-red-50 border border-red-200 rounded-xl text-center">
        <p class="text-red-700 font-medium">Hubo un error al enviar el mensaje</p>
        <a href="https://wa.me/5493476245523" target="_blank" class="text-red-600 text-sm mt-1 hover:underline inline-flex items-center gap-1 justify-center">
          Contáctanos por WhatsApp: +54 9 3476 24-5523
        </a>
      </div>

      <form id="contactForm" class="space-y-8">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="relative group reveal delay-100">
            <input 
              class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
              id="nombre" 
              name="nombre"
              placeholder="Nombre" 
              type="text"
              autocomplete="name"
              required
            />
            <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="nombre">
              Nombre
            </label>
          </div>
          <div class="relative group reveal delay-100">
            <input 
              class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
              id="email" 
              name="email"
              placeholder="Email" 
              type="email"
              autocomplete="email"
              required
            />
            <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="email">
              Email
            </label>
          </div>
        </div>
        
        <!-- Phone Input with intl-tel-input -->
        <div class="relative group reveal delay-100 z-20">
          <input 
            type="tel" 
            id="telefono" 
            name="telefono" 
            class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder:text-primary/40 focus:border-primary focus:ring-0 transition-colors"
            placeholder="Teléfono"
            required
            autocomplete="tel"
          />
          <span id="valid-msg" class="hidden text-green-600 text-xs mt-1">✓ Válido</span>
          <span id="error-msg" class="hidden text-red-600 text-xs mt-1"></span>
        </div>

        <div class="relative group reveal delay-200">
          <label class="block text-base text-primary/40 mb-3">¿Qué estás buscando?</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Página web" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Página web</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Marketing" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Marketing</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Contenido para redes" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Contenido para redes</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Branding" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Branding</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Aplicación" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Aplicación</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Otro" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Otro</span>
            </label>
          </div>
        </div>

        <div class="relative group reveal delay-300">
          <textarea 
            class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors resize-none overflow-hidden" 
            id="mensaje" 
            name="mensaje"
            placeholder="Detalles del Proyecto" 
            rows="2"
          ></textarea>
          <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="mensaje">
            Detalles del Proyecto
          </label>
        </div>
        
        <div class="reveal delay-300">
          <button 
            type="submit" 
            id="submitBtn"
            class="w-full bg-primary text-white py-4 px-8 rounded-full font-medium hover:bg-primary/90 transition-all duration-300 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="btn-text">Enviar Solicitud</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</section>



<style is:global>
  /* Override intl-tel-input styles to match design */
  .iti {
    display: block;
    width: 100%;
    margin-bottom: 0.5rem;
  }
  
  .iti__flag-container {
    border: none;
    background: transparent;
  }

  .iti__selected-flag {
    background: transparent !important;
    padding: 0 0px 0 0 !important;
  }
  
  /* Ensure the text color in the selected flag container (dial code) is visible and primary */
  .iti__selected-dial-code {
    color: var(--color-primary, #1e293b);
    font-size: 0.875rem;
  }

  /* Make the input look like the other inputs (border-bottom only) */
  #telefono {
    border: none;
    border-bottom: 1px solid #e5e7eb; /* gray-200 */
    border-radius: 0;
    box-shadow: none;
    width: 100%;
    text-indent: 5px;
  }

  #telefono:focus {
    border-bottom-color: var(--color-primary, #1e293b);
    box-shadow: none;
    outline: none;
  }

  /* Dropdown Styling */
  .iti__country-list {
    z-index: 100;
    background-color: white;
    border: 1px solid #e5e7eb; /* gray-200 */
    border-radius: 0.75rem; /* rounded-xl */
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    font-size: 0.875rem; /* text-sm */
    max-height: 200px;
    margin-top: 4px;
    overflow-y: auto;
    /* Force specific width and position to prevent "opening everywhere" */
    width: 250px !important;
    white-space: normal;
    left: 0 !important;
    
    /* Force dropdown to open downwards */
    top: 100% !important;
    bottom: auto !important;
    transform: none !important;
  }

  /* Hide the standard list and dividers to avoid duplicates with preferred countries */
  .iti__divider, .iti__country.iti__standard {
    display: none;
  }

  .iti__country {
    padding: 8px 12px;
    outline: none;
  }

  .iti__country:hover, .iti__country.iti__highlight {
    background-color: #f3f4f6; /* gray-50 */
  }

  .iti__country-name {
    color: #374151; /* gray-700 */
    margin-right: 6px;
  }
  
  .iti__dial-code {
    color: #9ca3af; /* gray-400 */
  }
</style>

<script>
  import intlTelInput from 'intl-tel-input';
  import 'intl-tel-input/build/css/intlTelInput.css';

  const form = document.getElementById('contactForm');
  const submitBtn = document.getElementById('submitBtn');
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');
  const input = document.querySelector("#telefono");
  const errorMsg = document.querySelector("#error-msg");
  const validMsg = document.querySelector("#valid-msg");

  // Error Map
  const errorMap = ["Número inválido", "Código de país inválido", "Demasiado corto", "Demasiado largo", "Número inválido"];

  let iti;

  if (input) {
    // Initialize intl-tel-input
    iti = intlTelInput(input, {
      utilsScript: "https://cdn.jsdelivr.net/npm/intl-tel-input@26.1.0/build/js/utils.js",
      // Restrict to specific countries
      onlyCountries: ['ar', 'uy', 'py', 'cl', 'co', 'pe', 'mx', 'es', 'us'],
      // Force this exact order by making them all "preferred" (appears at top, in order)
      preferredCountries: ['ar', 'uy', 'py', 'cl', 'co', 'pe', 'mx', 'es', 'us'],
      localizedCountries: {
        'pe': 'Perú',
        'mx': 'México',
        'es': 'España',
        'us': 'USA' 
      },
      separateDialCode: true,
      initialCountry: "auto",
      autoPlaceholder: "off",
      geoIpLookup: function(callback) {
        fetch("https://get.geojs.io/v1/ip/country.json")
          .then(function(res) { return res.json(); })
          .then(function(data) { callback(data.country); })
          .catch(function() { callback("ar"); });
      },
    });

    // Custom "Other" option logic
    const countryList = document.querySelector('.iti__country-list');
    if (countryList) {
      const otherOption = document.createElement('li');
      otherOption.classList.add('iti__country', 'iti__standard');
      otherOption.setAttribute('role', 'option');
      otherOption.innerHTML = `
        <div class="iti__flag-box"><div class="iti__flag iti__globe"></div></div>
        <span class="iti__country-name">Otro</span>
        <span class="iti__dial-code">+</span>
      `;
      
      otherOption.addEventListener('click', () => {
        // Reset to generic or clear
        iti.setCountry(''); // Clear country selection
        input.value = '+'; // helper for user
        input.focus();
      });
      
      countryList.appendChild(otherOption);
    }

    const reset = () => {
      input.classList.remove("error");
      errorMsg.innerHTML = "";
      errorMsg.classList.add("hidden");
      validMsg.classList.add("hidden");
    };

    // Validate on blur
    input.addEventListener('blur', () => {
      reset();
      if (input.value.trim()) {
        // CAMBIO: Aceptamos si la librería dice OK O si tiene más de 6 caracteres
        if (iti.isValidNumber() || input.value.trim().length > 6) {
           validMsg.classList.remove("hidden");
        } else {
           // If "Other" (no country data), validation fails. 
           // We can check if selected country data is empty
           const countryData = iti.getSelectedCountryData();
           
           if (!countryData.iso2) {
             // "Other" case - lenient validation (just check regex or length?)
             if(input.value.trim().length > 6) {
                validMsg.classList.remove("hidden");
             }
           } else {
             input.classList.add("error");
             const errorCode = iti.getValidationError();
             errorMsg.innerHTML = errorMap[errorCode] || "Número inválido";
             errorMsg.classList.remove("hidden");
           }
        }
      }
    });

    // Reset on change/keyup
    input.addEventListener('change', reset);
    input.addEventListener('keyup', reset);
  }

  // Form Submission
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const countryData = iti ? iti.getSelectedCountryData() : {};
      
      // Basic validation check before submit
      // CAMBIO: Solo bloqueamos si el número es evidentemente muy corto (menos de 6 números)
      // Ignoramos !iti.isValidNumber() para permitir formatos "imperfectos" de Argentina
      if (iti && countryData.iso2 && input.value.trim().length < 6) {
        // Mostramos error genérico
        errorMsg.innerHTML = "Número demasiado corto";
        errorMsg.classList.remove("hidden");
        if (input) input.focus();
        return;
      }

      // Ocultar mensajes previos
      if (successMessage) successMessage.classList.add('hidden');
      if (errorMessage) errorMessage.classList.add('hidden');

      // Estado de loading
      const originalBtnText = submitBtn.innerText;
      if (submitBtn) {
          submitBtn.innerText = 'Enviando...';
          submitBtn.disabled = true;
      }

      const formData = new FormData(form);
      
      // Get full number from intl-tel-input
      const fullPhone = iti ? iti.getNumber() : formData.get('telefono');

      // Capturar servicios seleccionados
      const servicios = formData.getAll('services[]');

      const data = {
        nombre: formData.get('nombre'),
        email: formData.get('email'),
        telefono: fullPhone,
        servicios: servicios,
        mensaje: formData.get('mensaje')
      };

      try {
        const response = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          // ÉXITO
          form.classList.add('hidden');
          if (successMessage) successMessage.classList.remove('hidden'); 
          form.reset();
        } else {
          throw new Error('Error en el servidor');
        }
      } catch (error) {
        console.error(error);
        if (errorMessage) errorMessage.classList.remove('hidden');
      } finally {
        if (submitBtn) {
            submitBtn.innerText = originalBtnText;
            submitBtn.disabled = false;
        }
      }
    });
  }
</script>
