---
import Button from './UI/Button.astro';
---

<section class="py-24 px-6 md:px-12 bg-surface" id="contact">
  <div class="max-w-2xl mx-auto reveal">
    <div class="bg-white p-8 md:p-14 rounded-3xl shadow-apple hover:shadow-apple-hover transition-shadow duration-300 border border-white">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-semibold mb-3 tracking-tight">Â¿Tu negocio estÃ¡ listo para escalar?</h2>
        <p class="text-sm text-primary/50">CuÃ©ntanos sobre tu proyecto y te contactaremos en menos de 24h.</p>
      </div>
      
      <!-- Success Message -->
      <div id="success-message" class="hidden mb-8 p-4 bg-green-50 border border-green-200 rounded-xl text-center">
        <p class="text-green-700 font-medium">Â¡Mensaje enviado con Ã©xito!</p>
        <p class="text-green-600 text-sm mt-1">Te contactaremos pronto.</p>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="hidden mb-8 p-4 bg-red-50 border border-red-200 rounded-xl text-center">
        <p class="text-red-700 font-medium">Hubo un error al enviar el mensaje</p>
        <p class="text-red-600 text-sm mt-1">Por favor intenta nuevamente.</p>
      </div>

      <form id="contactForm" class="space-y-8">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="relative group reveal delay-100">
            <input 
              class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
              id="nombre" 
              name="nombre"
              placeholder="Nombre" 
              type="text"
              autocomplete="name"
              required
            />
            <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="nombre">
              Nombre
            </label>
          </div>
          <div class="relative group reveal delay-100">
            <input 
              class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
              id="email" 
              name="email"
              placeholder="Email" 
              type="email"
              autocomplete="email"
              required
            />
            <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="email">
              Email
            </label>
          </div>
        </div>
        
        <!-- Field for phone (optional, matching backend) -->
        <div class="relative group reveal delay-100">
             <div class="flex items-end gap-4">
               <div class="w-24">
                  <label for="countryCode" class="sr-only">PaÃ­s</label>
                  <select 
                    id="countryCode" 
                    name="countryCode" 
                    class="w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary focus:border-primary focus:ring-0 transition-colors cursor-pointer appearance-none"
                  >
                    <option value="+54">ðŸ‡¦ðŸ‡· +54</option>
                    <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                    <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
                    <option value="+52">ðŸ‡²ðŸ‡½ +52</option>
                    <option value="+57">ðŸ‡¨ðŸ‡´ +57</option>
                    <option value="+56">ðŸ‡¨ðŸ‡± +56</option>
                    <option value="+598">ðŸ‡ºðŸ‡¾ +598</option>
                    <option value="+51">ðŸ‡µðŸ‡ª +51</option>
                    <option value="">Otro</option>
                  </select>
               </div>
               <div class="relative flex-1">
                 <input 
                   class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
                   id="telefono" 
                   name="telefono"
                   placeholder="TelÃ©fono (Opcional)" 
                   type="tel"
                   autocomplete="tel"
                 />
                 <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="telefono">
                   TelÃ©fono (Opcional)
                 </label>
               </div>
             </div>
        </div>

        <div class="relative group reveal delay-200">
          <label class="block text-base text-primary/40 mb-3">Â¿QuÃ© estÃ¡s buscando?</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="PÃ¡gina web" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">PÃ¡gina web</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Marketing" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Marketing</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Contenido para redes" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Contenido para redes</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Branding" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Branding</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="AplicaciÃ³n" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">AplicaciÃ³n</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Otro" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Otro</span>
            </label>
          </div>
        </div>

        <div class="relative group reveal delay-300">
          <textarea 
            class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors resize-none overflow-hidden" 
            id="mensaje" 
            name="mensaje"
            placeholder="Detalles del Proyecto (Opcional)" 
            rows="2"
          ></textarea>
          <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="mensaje">
            Detalles del Proyecto (Opcional)
          </label>
        </div>
        
        <div class="pt-6 reveal delay-300">
          <button 
            type="submit" 
            id="submitBtn"
            class="w-full bg-primary text-white py-4 px-8 rounded-full font-medium hover:bg-primary/90 transition-all duration-300 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="btn-text">Enviar Solicitud</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById('contactForm');
  const submitBtn = document.getElementById('submitBtn');
  // Referencias a los mensajes de Ã©xito y error que ya existen en tu HTML
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Resetear estados visuales (ocultar mensajes previos)
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');

      // Estado de "Cargando"
      const originalBtnText = submitBtn.innerText;
      submitBtn.innerText = 'Enviando...';
      submitBtn.disabled = true;

      const formData = new FormData(form);
      
      // Combinar cÃ³digo de paÃ­s con telÃ©fono
      const countryCode = document.getElementById('countryCode').value;
      const phoneNumber = formData.get('telefono');
      const fullPhone = phoneNumber ? `${countryCode} ${phoneNumber}` : '';

      // Capturar servicios seleccionados
      const servicios = formData.getAll('services[]');

      const data = {
        nombre: formData.get('nombre'),
        email: formData.get('email'),
        telefono: fullPhone.trim(),
        servicios: servicios,
        mensaje: formData.get('mensaje')
      };

      try {
        const response = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          // Ã‰XITO: Mostramos el div verde "Premium" en lugar de alert
          successMessage.classList.remove('hidden'); 
          form.reset();
          
          // Opcional: Hacer scroll hacia el mensaje para asegurar que lo vean
          successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          throw new Error('Error en el servidor');
        }
      } catch (error) {
        console.error(error);
        // ERROR: Mostramos el div rojo en lugar de alert
        errorMessage.classList.remove('hidden');
      } finally {
        submitBtn.innerText = originalBtnText;
        submitBtn.disabled = false;
      }
    });
  }
</script>
