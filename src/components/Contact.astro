---
import Button from './UI/Button.astro';
---

<section class="py-24 px-6 md:px-12 bg-surface" id="contact">
  <div class="max-w-2xl mx-auto reveal">
    <div class="bg-white p-8 md:p-14 rounded-3xl shadow-apple hover:shadow-apple-hover transition-shadow duration-300 border border-white">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-semibold mb-3 tracking-tight">¿Tu negocio está listo para escalar?</h2>
        <p class="text-sm text-primary/50">Cuéntanos sobre tu proyecto y te contactaremos en menos de 24h.</p>
      </div>
      
      <!-- Success Message -->
      <div id="success-message" class="hidden mb-8 p-4 bg-green-50 border border-green-200 rounded-xl text-center">
        <p class="text-green-700 font-medium">¡Mensaje enviado con éxito!</p>
        <p class="text-green-600 text-sm mt-1">Te contactaremos pronto.</p>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="hidden mb-8 p-4 bg-red-50 border border-red-200 rounded-xl text-center">
        <p class="text-red-700 font-medium">Hubo un error al enviar el mensaje</p>
        <p class="text-red-600 text-sm mt-1">Por favor intenta nuevamente.</p>
      </div>

      <form id="contactForm" class="space-y-8">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="relative group reveal delay-100">
            <input 
              class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-base text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
              id="nombre" 
              name="nombre"
              placeholder="Nombre" 
              type="text"
              required
            />
            <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="nombre">
              Nombre
            </label>
          </div>
          <div class="relative group reveal delay-100">
            <input 
              class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-base text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
              id="email" 
              name="email"
              placeholder="Email" 
              type="email"
              required
            />
            <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="email">
              Email
            </label>
          </div>
        </div>
        
        <!-- Field for phone (optional, matching backend) -->
        <div class="relative group reveal delay-100">
             <input 
               class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-base text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
               id="telefono" 
               name="telefono"
               placeholder="Teléfono (Opcional)" 
               type="tel"
             />
             <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="telefono">
               Teléfono (Opcional)
             </label>
        </div>

        <div class="relative group reveal delay-200">
          <label class="block text-base text-primary/40 mb-3">¿Qué estás buscando?</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Página web" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Página web</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Marketing" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Marketing</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Contenido para redes" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Contenido para redes</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Branding" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Branding</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Aplicación" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Aplicación</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Otro" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Otro</span>
            </label>
          </div>
        </div>

        <div class="relative group reveal delay-300">
          <textarea 
            class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-base text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors resize-none overflow-hidden" 
            id="mensaje" 
            name="mensaje"
            placeholder="Detalles del Proyecto" 
            rows="2"
            required
          ></textarea>
          <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="mensaje">
            Detalles del Proyecto
          </label>
        </div>
        
        <div class="pt-6 reveal delay-300">
          <button 
            type="submit" 
            id="submitBtn"
            class="w-full bg-primary text-white py-4 px-8 rounded-full font-medium hover:bg-primary/90 transition-all duration-300 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="btn-text">Enviar Solicitud</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  // Esta lógica corre en el navegador del cliente
  const form = document.getElementById('contactForm');
  const submitBtn = document.getElementById('submitBtn');

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // Evita que la página se recargue

      // Estado de "Cargando"
      const originalBtnText = submitBtn.innerText;
      submitBtn.innerText = 'Enviando...';
      submitBtn.disabled = true;

      // Capturar datos
      const formData = new FormData(form);
      const data = {
        nombre: formData.get('nombre'),
        email: formData.get('email'),
        telefono: formData.get('telefono'),
        mensaje: formData.get('mensaje')
      };

      try {
        const response = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          alert('¡Mensaje enviado con éxito! Nos pondremos en contacto pronto.');
          form.reset(); // Limpiar formulario
        } else {
          throw new Error('Error en el servidor');
        }
      } catch (error) {
        console.error(error);
        alert('Hubo un error al enviar el mensaje. Por favor intenta nuevamente o escribinos por WhatsApp.');
      } finally {
        // Restaurar botón
        submitBtn.innerText = originalBtnText;
        submitBtn.disabled = false;
      }
    });
  }
</script>
