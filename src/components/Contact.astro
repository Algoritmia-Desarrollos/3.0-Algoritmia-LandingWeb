---
import Button from './UI/Button.astro';
---

<section class="py-24 px-6 md:px-12 bg-surface" id="contact">
  <div class="max-w-2xl mx-auto reveal">
    <div class="bg-white p-8 md:p-14 rounded-3xl shadow-apple hover:shadow-apple-hover transition-shadow duration-300 border border-white">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-semibold mb-3 tracking-tight">Comienza tu Viaje</h2>
        <p class="text-sm text-primary/50">Cuéntanos sobre tu proyecto y te contactaremos en 24h.</p>
      </div>
      
      <!-- Success Message -->
      <div id="success-message" class="hidden mb-8 p-4 bg-green-50 border border-green-200 rounded-xl text-center">
        <p class="text-green-700 font-medium">¡Mensaje enviado con éxito!</p>
        <p class="text-green-600 text-sm mt-1">Te contactaremos pronto.</p>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="hidden mb-8 p-4 bg-red-50 border border-red-200 rounded-xl text-center">
        <p class="text-red-700 font-medium">Hubo un error al enviar el mensaje</p>
        <p class="text-red-600 text-sm mt-1">Por favor intenta nuevamente.</p>
      </div>

      <form id="contact-form" class="space-y-8">
        <!-- Hidden field for Web3Forms access key -->
        <input type="hidden" name="access_key" value="392a0797-bcaa-4eb1-8b30-1b03db06d3ec">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="relative group reveal delay-100">
            <input 
              class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-base text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
              id="name" 
              name="name"
              placeholder="Nombre" 
              type="text"
              required
            />
            <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="name">
              Nombre
            </label>
          </div>
          <div class="relative group reveal delay-100">
            <input 
              class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-base text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
              id="email" 
              name="email"
              placeholder="Email" 
              type="email"
              required
            />
            <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="email">
              Email
            </label>
          </div>
        </div>
        
        <div class="relative group reveal delay-200">
          <label class="block text-base text-primary/40 mb-3">¿Qué estás buscando?</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Página web" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Página web</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Marketing" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Marketing</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Contenido para redes" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Contenido para redes</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Branding" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Branding</span>
            </label>
          </div>
        </div>

        <div class="relative group reveal delay-300">
          <textarea 
            class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-base text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors resize-none overflow-hidden" 
            id="message" 
            name="message"
            placeholder="Detalles del Proyecto" 
            rows="2"
            required
          ></textarea>
          <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="message">
            Detalles del Proyecto
          </label>
        </div>
        
        <div class="pt-6 reveal delay-300">
          <button 
            type="submit" 
            id="submit-btn"
            class="w-full bg-primary text-white py-4 px-8 rounded-full font-medium hover:bg-primary/90 transition-all duration-300 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="btn-text">Aplicar para trabajar juntos</span>
            <span id="btn-loading" class="hidden">Enviando...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  function initContactForm() {
    const form = document.getElementById('contact-form');
    const submitBtn = document.getElementById('submit-btn');
    const btnText = document.getElementById('btn-text');
    const btnLoading = document.getElementById('btn-loading');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const messageTextarea = document.getElementById('message');

    if (!form) return;

    // Auto-resize textarea
    if (messageTextarea) {
      const autoResize = () => {
        messageTextarea.style.height = 'auto';
        messageTextarea.style.height = messageTextarea.scrollHeight + 'px';
      };

      messageTextarea.addEventListener('input', autoResize);
      // Initial resize in case there's pre-filled content
      autoResize();
    }

    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      // Hide previous messages
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');

      // Show loading state
      submitBtn.disabled = true;
      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');

      try {
        const formData = new FormData(form);
        
        const response = await fetch('https://api.web3forms.com/submit', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (response.ok && data.success) {
          // Show success message
          successMessage.classList.remove('hidden');
          
          // Reset form
          form.reset();
          
          // Reset textarea height
          if (messageTextarea) {
            messageTextarea.style.height = 'auto';
          }

          // Scroll to success message
          successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          // Show error message
          errorMessage.classList.remove('hidden');
          
          // Scroll to error message
          errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        
        // Show error message
        errorMessage.classList.remove('hidden');
        
        // Scroll to error message
        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } finally {
        // Reset button state
        submitBtn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
      }
    });
  }

  // Run on load
  initContactForm();

  // Run on view transitions if enabled
  document.addEventListener('astro:page-load', initContactForm);
</script>
