---
import Button from './UI/Button.astro';
---

<section class="py-24 px-6 md:px-12 bg-surface" id="contact">
  <div class="max-w-2xl mx-auto reveal">
    <div class="bg-white p-8 md:p-14 rounded-3xl shadow-apple hover:shadow-apple-hover transition-shadow duration-300 border border-white">
      <div class="text-center mb-12">
        <h2 class="text-3xl font-semibold mb-3 tracking-tight">¬øTu negocio est√° listo para escalar?</h2>
        <p class="text-sm text-primary/50">Cu√©ntanos sobre tu proyecto y te contactaremos en menos de 24h.</p>
      </div>
      
      <!-- Success Message -->
      <div id="success-message" class="hidden mb-8 p-4 bg-green-50 border border-green-200 rounded-xl text-center">
        <p class="text-green-700 font-medium">¬°Mensaje enviado con √©xito!</p>
        <p class="text-green-600 text-sm mt-1">Te contactaremos pronto.</p>
      </div>

      <!-- Error Message -->
      <div id="error-message" class="hidden mb-8 p-4 bg-red-50 border border-red-200 rounded-xl text-center">
        <p class="text-red-700 font-medium">Hubo un error al enviar el mensaje</p>
        <a href="https://wa.me/5493476245523" target="_blank" class="text-red-600 text-sm mt-1 hover:underline inline-flex items-center gap-1 justify-center">
          Cont√°ctanos por WhatsApp: +54 9 3476 24-5523
        </a>
      </div>

      <form id="contactForm" class="space-y-8">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="relative group reveal delay-100">
            <input 
              class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
              id="nombre" 
              name="nombre"
              placeholder="Nombre" 
              type="text"
              autocomplete="name"
              required
            />
            <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="nombre">
              Nombre
            </label>
          </div>
          <div class="relative group reveal delay-100">
            <input 
              class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
              id="email" 
              name="email"
              placeholder="Email" 
              type="email"
              autocomplete="email"
              required
            />
            <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="email">
              Email
            </label>
          </div>
        </div>
        
        <!-- Field for phone (optional, matching backend) -->
        <div class="relative group reveal delay-100 z-20">
             <div class="flex items-end gap-4">
               <div class="relative w-32" id="customCountrySelector">
                  <input type="hidden" id="countryCode" name="countryCode" value="+54">
                  <button type="button" id="countryBtn" class="w-full flex items-center justify-between border-0 border-b border-gray-200 py-3 px-1 text-sm text-primary transition-colors focus:border-primary bg-transparent text-left gap-2">
                      <div class="flex items-center gap-2 truncate">
                        <img id="selectedFlag" src="https://flagcdn.com/w40/ar.png" alt="Argentina" class="w-6 h-auto object-cover rounded-sm border border-gray-100/50">
                        <span id="selectedCode">+54</span>
                      </div>
                      <svg class="w-4 h-4 text-primary/50 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                  </button>
                  
                  <!-- Dropdown List -->
                  <ul id="countryList" class="hidden absolute z-50 top-full left-0 w-64 bg-white rounded-xl shadow-xl border border-gray-100 mt-1 max-h-60 overflow-y-auto py-1">
                      <li>
                        <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex gap-3 items-center text-primary group" data-value="+54" data-flag="ar" data-country="Argentina">
                          <img src="https://flagcdn.com/w40/ar.png" alt="Argentina" class="w-5 h-auto object-cover rounded-sm border border-gray-100 group-hover:border-gray-300 transition-colors">
                          <span>Argentina (+54)</span>
                        </button>
                      </li>
                      <li>
                        <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex gap-3 items-center text-primary group" data-value="+598" data-flag="uy" data-country="Uruguay">
                          <img src="https://flagcdn.com/w40/uy.png" alt="Uruguay" class="w-5 h-auto object-cover rounded-sm border border-gray-100 group-hover:border-gray-300 transition-colors">
                          <span>Uruguay (+598)</span>
                        </button>
                      </li>
                      <li>
                        <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex gap-3 items-center text-primary group" data-value="+595" data-flag="py" data-country="Paraguay">
                          <img src="https://flagcdn.com/w40/py.png" alt="Paraguay" class="w-5 h-auto object-cover rounded-sm border border-gray-100 group-hover:border-gray-300 transition-colors">
                          <span>Paraguay (+595)</span>
                        </button>
                      </li>
                      <li>
                        <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex gap-3 items-center text-primary group" data-value="+56" data-flag="cl" data-country="Chile">
                          <img src="https://flagcdn.com/w40/cl.png" alt="Chile" class="w-5 h-auto object-cover rounded-sm border border-gray-100 group-hover:border-gray-300 transition-colors">
                          <span>Chile (+56)</span>
                        </button>
                      </li>
                      <li>
                        <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex gap-3 items-center text-primary group" data-value="+57" data-flag="co" data-country="Colombia">
                          <img src="https://flagcdn.com/w40/co.png" alt="Colombia" class="w-5 h-auto object-cover rounded-sm border border-gray-100 group-hover:border-gray-300 transition-colors">
                          <span>Colombia (+57)</span>
                        </button>
                      </li>
                      <li>
                        <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex gap-3 items-center text-primary group" data-value="+51" data-flag="pe" data-country="Per√∫">
                          <img src="https://flagcdn.com/w40/pe.png" alt="Per√∫" class="w-5 h-auto object-cover rounded-sm border border-gray-100 group-hover:border-gray-300 transition-colors">
                          <span>Per√∫ (+51)</span>
                        </button>
                      </li>
                      <li>
                        <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex gap-3 items-center text-primary group" data-value="+52" data-flag="mx" data-country="M√©xico">
                          <img src="https://flagcdn.com/w40/mx.png" alt="M√©xico" class="w-5 h-auto object-cover rounded-sm border border-gray-100 group-hover:border-gray-300 transition-colors">
                          <span>M√©xico (+52)</span>
                        </button>
                      </li>
                      <li>
                        <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex gap-3 items-center text-primary group" data-value="+34" data-flag="es" data-country="Espa√±a">
                          <img src="https://flagcdn.com/w40/es.png" alt="Espa√±a" class="w-5 h-auto object-cover rounded-sm border border-gray-100 group-hover:border-gray-300 transition-colors">
                          <span>Espa√±a (+34)</span>
                        </button>
                      </li>
                      <li>
                        <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex gap-3 items-center text-primary group" data-value="+1" data-flag="us" data-country="USA">
                          <img src="https://flagcdn.com/w40/us.png" alt="USA" class="w-5 h-auto object-cover rounded-sm border border-gray-100 group-hover:border-gray-300 transition-colors">
                          <span>USA (+1)</span>
                        </button>
                      </li>
                      <li>
                        <button type="button" class="w-full text-left px-4 py-2 hover:bg-gray-50 text-sm flex gap-3 items-center text-primary group" data-value="" data-flag="other" data-country="Otro">
                          <span class="w-5 h-auto flex items-center justify-center text-base">üåê</span>
                          <span>Otro</span>
                        </button>
                      </li>
                  </ul>
               </div>
               <div class="relative flex-1">
                 <input 
                   class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors" 
                   id="telefono" 
                   name="telefono"
                   placeholder="N√∫mero de tel√©fono" 
                   type="tel"
                   autocomplete="tel"
                   required
                 />
                 <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="telefono">
                   N√∫mero de tel√©fono
                 </label>
               </div>
             </div>
        </div>

        <div class="relative group reveal delay-200">
          <label class="block text-base text-primary/40 mb-3">¬øQu√© est√°s buscando?</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="P√°gina web" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">P√°gina web</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Marketing" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Marketing</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Contenido para redes" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Contenido para redes</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Branding" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Branding</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Aplicaci√≥n" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Aplicaci√≥n</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer group/checkbox">
              <input type="checkbox" name="services[]" value="Otro" class="w-4 h-4 rounded border-gray-300 text-primary focus:ring-primary focus:ring-offset-0">
              <span class="text-sm text-primary group-hover/checkbox:text-primary/80 transition-colors">Otro</span>
            </label>
          </div>
        </div>

        <div class="relative group reveal delay-300">
          <textarea 
            class="peer w-full border-0 border-b border-gray-200 bg-transparent py-3 px-1 text-sm text-primary placeholder-transparent focus:border-primary focus:ring-0 transition-colors resize-none overflow-hidden" 
            id="mensaje" 
            name="mensaje"
            placeholder="Detalles del Proyecto" 
            rows="2"
          ></textarea>
          <label class="absolute left-1 -top-3.5 text-xs text-primary/40 transition-all peer-placeholder-shown:top-3.5 peer-placeholder-shown:text-base peer-placeholder-shown:text-primary/40 peer-focus:-top-3.5 peer-focus:text-xs peer-focus:text-primary pointer-events-none" for="mensaje">
            Detalles del Proyecto
          </label>
        </div>
        
        <div class="pt-6 reveal delay-300">
          <button 
            type="submit" 
            id="submitBtn"
            class="w-full bg-primary text-white py-4 px-8 rounded-full font-medium hover:bg-primary/90 transition-all duration-300 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span id="btn-text">Enviar Solicitud</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</section>

<script>
  const form = document.getElementById('contactForm');
  const submitBtn = document.getElementById('submitBtn');
  const successMessage = document.getElementById('success-message');
  const errorMessage = document.getElementById('error-message');

  // Custom Dropdown Logic
  const countryBtn = document.getElementById('countryBtn');
  const countryList = document.getElementById('countryList');
  const countryInput = document.getElementById('countryCode'); // Hidden input
  const selectedCode = document.getElementById('selectedCode');
  const selectedFlag = document.getElementById('selectedFlag');
  const dropdownOptions = document.querySelectorAll('#countryList button');

  // Toggle Dropdown
  if (countryBtn && countryList) {
    countryBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      countryList.classList.toggle('hidden');
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      if (!countryBtn.contains(e.target) && !countryList.contains(e.target)) {
        countryList.classList.add('hidden');
      }
    });

    // Handle Selection
    dropdownOptions.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const target = e.currentTarget;
        const val = target.getAttribute('data-value');
        const flag = target.getAttribute('data-flag');
        const countryName = target.getAttribute('data-country');

        if (countryInput) countryInput.value = val || '';
        
        // Update UI
        if (selectedCode) selectedCode.textContent = val || '';
        if (selectedFlag) {
            if (flag && flag !== 'other') {
                selectedFlag.src = `https://flagcdn.com/w40/${flag}.png`;
                selectedFlag.alt = countryName || '';
                selectedFlag.classList.remove('hidden');
            } else {
                // For "Other", maybe show a globe or hide image
                 selectedFlag.src = ''; // Or a default placeholder
                 selectedFlag.classList.add('hidden'); // Hide if no flag
            }
        }
        
        countryList.classList.add('hidden');
      });
    });
  }

  // Smart Phone Input Logic
  const phoneInput = document.getElementById('telefono');
  if (phoneInput && dropdownOptions.length > 0) {
      const handlePhoneInput = () => {
          const val = phoneInput.value.trim();
          if (val.startsWith('+')) {
              // Sort by length desc to match +598 before +59 (if valid)
              const match = Array.from(dropdownOptions)
                  .map(btn => ({ btn, code: btn.getAttribute('data-value') }))
                  .sort((a, b) => (b.code ? b.code.length : 0) - (a.code ? a.code.length : 0))
                  .find(({ code }) => code && val.startsWith(code));

              if (match) {
                  // Trigger selection
                  match.btn.click();
                  // Strip code from input
                  phoneInput.value = val.slice(match.code.length).trim();
              }
          }
      };

      phoneInput.addEventListener('input', handlePhoneInput);
      phoneInput.addEventListener('change', handlePhoneInput); 
  }

  // Auto-detect country code
  fetch('https://ipapi.co/json/')
    .then(res => res.json())
    .then(data => {
      if (data.country_code) {
        const code = data.country_calling_code; 
        const flagCode = data.country_code.toLowerCase();

        // Update custom dropdown
        // Try to match by flag code first (more robust)
        let matchingBtn = Array.from(dropdownOptions).find(btn => btn.getAttribute('data-flag') === flagCode);
        
        // Fallback to calling code match if flag not found (e.g. rare countries)
        if (!matchingBtn) {
            matchingBtn = Array.from(dropdownOptions).find(btn => btn.getAttribute('data-value') === code);
        }

        if (matchingBtn) {
           const val = matchingBtn.getAttribute('data-value');
           const flag = matchingBtn.getAttribute('data-flag');
           const countryName = matchingBtn.getAttribute('data-country');

           if (countryInput) countryInput.value = val;
           if (selectedCode) selectedCode.textContent = val;
           if (selectedFlag && flag && flag !== 'other') {
               selectedFlag.src = `https://flagcdn.com/w40/${flag}.png`;
               selectedFlag.alt = countryName;
               selectedFlag.classList.remove('hidden');
           }
        }
      }
    })
    .catch(() => {});

  // Form Submission
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Ocultar mensajes previos
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');

      // Estado de loading
      const originalBtnText = submitBtn.innerText;
      submitBtn.innerText = 'Enviando...';
      submitBtn.disabled = true;

      const formData = new FormData(form);
      
      // Combinar c√≥digo de pa√≠s con tel√©fono
      const currentCode = countryInput ? countryInput.value : '';
      const phoneNumber = formData.get('telefono');
      const fullPhone = phoneNumber ? `${currentCode} ${phoneNumber}` : '';

      // Capturar servicios seleccionados
      const servicios = formData.getAll('services[]');

      const data = {
        nombre: formData.get('nombre'),
        email: formData.get('email'),
        telefono: fullPhone.trim(),
        servicios: servicios,
        mensaje: formData.get('mensaje')
      };

      try {
        const response = await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          // √âXITO: 
          // 1. Ocultamos el formulario
          form.classList.add('hidden');
          // 2. Mostramos mensaje de √©xito en su lugar (sin scroll)
          successMessage.classList.remove('hidden'); 
          
          form.reset();
        } else {
          throw new Error('Error en el servidor');
        }
      } catch (error) {
        console.error(error);
        // ERROR: Mostramos el div rojo en lugar de alert
        errorMessage.classList.remove('hidden');
        // Opcional: mostrar de nuevo el form si estaba oculto (aunque aqu√≠ no se ocult√≥ antes de error)
      } finally {
        submitBtn.innerText = originalBtnText;
        submitBtn.disabled = false;
      }
    });
  }
</script>
