---
---

<header class="fixed top-0 left-0 right-0 z-50 flex justify-center pt-2 md:pt-4 px-4 pointer-events-none">
  <div id="navbar" class="pointer-events-auto glass-nav border border-white/20 shadow-lg shadow-black/5 rounded-[2rem] px-6 md:px-8 py-3 flex flex-col md:flex-row items-center gap-0 md:gap-24 transition-all duration-300 ring-1 ring-black/5 w-[95%] md:w-auto overflow-hidden max-h-[64px] md:max-h-none">
    
    <div class="flex items-center justify-between w-full md:w-auto relative">
      <a href="/" id="logo-link" class="home-link flex items-center gap-2 text-primary hover:opacity-80 transition-opacity">
        <span class="material-symbols-outlined text-[20px]">token</span>
        <span class="text-sm font-semibold tracking-tight">Algoritmia</span>
      </a>

      <div class="flex items-center gap-4 md:hidden">
        <button id="mobile-menu-btn" class="text-primary p-1 rounded-full hover:bg-black/5 transition-colors">
          <span class="material-symbols-outlined text-[24px] transition-transform duration-300" id="menu-icon">menu</span>
        </button>
      </div>
    </div>

    <nav class="hidden md:flex items-center gap-1">
      <a class="home-link text-[13px] font-medium text-primary/80 hover:text-primary transition-all px-4 py-2 rounded-full hover:bg-black/5" href="/">Inicio</a>
      <a class="text-[13px] font-medium text-primary/80 hover:text-primary transition-all px-4 py-2 rounded-full hover:bg-black/5" href="/#services">Servicios</a>
      <a class="text-[13px] font-medium text-primary/80 hover:text-primary transition-all px-4 py-2 rounded-full hover:bg-black/5" href="/#work">Proyectos</a>
      <a class="text-[13px] font-medium text-primary/80 hover:text-primary transition-all px-4 py-2 rounded-full hover:bg-black/5" href="/#philosophy">Filosofía</a>
    </nav>

    <div class="hidden md:flex items-center gap-4 pl-2">
      <a class="bg-primary text-white px-5 py-2 rounded-full text-[13px] font-medium hover:bg-black/90 transition-all shadow-md shadow-primary/10" href="/#contact">
        Contacto
      </a>
    </div>

    <!-- Mobile Menu Items -->
    <div class="md:hidden flex flex-col gap-6 pt-8 pb-4 w-full opacity-0 transition-opacity duration-300 delay-100" id="mobile-menu-items">
      <nav class="flex flex-col gap-4">
        <a class="home-link text-lg font-medium text-primary/80 hover:text-primary transition-colors border-b border-black/5 pb-2" href="/">Inicio</a>
        <a class="text-lg font-medium text-primary/80 hover:text-primary transition-colors border-b border-black/5 pb-2" href="/#services">Servicios</a>
        <a class="text-lg font-medium text-primary/80 hover:text-primary transition-colors border-b border-black/5 pb-2" href="/#work">Proyectos</a>
        <a class="text-lg font-medium text-primary/80 hover:text-primary transition-colors border-b border-black/5 pb-2" href="/#philosophy">Filosofía</a>
      </nav>
      <a class="bg-primary text-white px-5 py-3 rounded-xl text-center text-sm font-medium hover:bg-black/90 transition-all shadow-md shadow-primary/10 w-full" href="/#contact">
        Contacto
      </a>
    </div>
  </div>
</header>

<style>
  .glass-nav {
    background: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }
</style>

<script>
  function setupNavbar() {
    const btn = document.getElementById('mobile-menu-btn');
    const navbar = document.getElementById('navbar');
    const menuItems = document.getElementById('mobile-menu-items');
    const menuIcon = document.getElementById('menu-icon');
    let isOpen = false;

    function openMenu() {
      isOpen = true;
      navbar?.classList.remove('max-h-[64px]');
      navbar?.classList.add('max-h-[400px]', 'bg-white'); // Expand and solidify bg
      menuItems?.classList.remove('opacity-0');
      if (menuIcon) menuIcon.textContent = 'close';
    }

    function closeMenu() {
      isOpen = false;
      navbar?.classList.add('max-h-[64px]');
      navbar?.classList.remove('max-h-[400px]', 'bg-white');
      menuItems?.classList.add('opacity-0');
      if (menuIcon) menuIcon.textContent = 'menu';
    }

    // Remove existing listeners to prevent duplication if elements persist (though usually they are replaced)
    // A simpler approach is to clone and replace, or just add new ones if we are sure elements are new.
    // With View Transitions, body content is replaced, so elements are new.

    btn?.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent immediate closing from document click
      if (isOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    // Close menu when clicking a link
    const mobileLinks = menuItems?.querySelectorAll('a');
    mobileLinks?.forEach(link => {
      link.addEventListener('click', () => {
        closeMenu();
      });
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (isOpen && navbar && !navbar.contains(e.target as Node) && !btn?.contains(e.target as Node)) {
        closeMenu();
      }
    });

    // Close menu on scroll
    window.addEventListener('scroll', () => {
      if (isOpen) {
        closeMenu();
      }
    }, { passive: true });
  }

  function setupSmoothScroll() {
    document.querySelectorAll('a[href^="/#"], a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        const href = this.getAttribute('href');
        const targetId = href.includes('#') ? href.split('#')[1] : null;
        
        if (targetId) {
          const targetElement = document.getElementById(targetId);
          
          if (targetElement) {
            e.preventDefault();
            e.stopImmediatePropagation();
            
            // Cerrar menú móvil
            document.body.click(); 

            // Scroll con Lenis
            // @ts-ignore
            if (window.lenis) {
                // @ts-ignore
                window.lenis.scrollTo(targetElement, { 
                    offset: 0, 
                    duration: 1.0, // Un pelín más lento solo al hacer click en menú
                    immediate: false 
                });
            } else {
                targetElement.scrollIntoView({ behavior: 'smooth' });
            }
            history.pushState(null, null, `#${targetId}`);
          }
        }
      });
    });
    
    // Lógica para el logo (Home link)
    const homeLinks = document.querySelectorAll('.home-link');
    homeLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        if (window.location.pathname === '/' || window.location.pathname === '') {
          e.preventDefault();
          e.stopImmediatePropagation();
          
          // Scroll al tope con Lenis
          // @ts-ignore
          if (window.lenis) window.lenis.scrollTo(0);
          else window.scrollTo({ top: 0, behavior: 'smooth' });
          
          document.body.click(); 
          history.pushState(null, null, '/');
        }
      });
    });
  }

  // Run on initial load
  setupNavbar();
  setupSmoothScroll();

  // Run on view transitions
  document.addEventListener('astro:page-load', () => {
    setupNavbar();
    setupSmoothScroll();
  });
</script>
